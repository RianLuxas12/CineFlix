<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CINEFLIX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --red:#e50914; --bg:#000; --panel:#111; --card:#222; }
  body { background:var(--bg); color:#fff; font-family:Arial, sans-serif; margin:0; }
  #logo { font-size:56px; color:var(--red); margin:24px 0; text-align:center; }

  .box { width:330px; max-width:92%; margin:20px auto; background:var(--panel); padding:22px; border-radius:10px; text-align:center; }
  input, select { width:92%; padding:12px; margin-top:10px; background:#1d1d1d; border:none; border-radius:6px; color:#fff; }
  button { padding:12px 16px; margin-top:12px; background:var(--red); border:none; color:#fff; border-radius:6px; cursor:pointer; }
  .btn-wide { width:95%; }
  .alt { background:#333; }

  header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:var(--panel); }
  header h3 { margin:0; font-weight:normal; }

  nav { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; padding:12px 10px; background:var(--panel); }
  nav button { background:#1d1d1d; color:#fff; border:none; padding:10px 16px; border-radius:6px; }
  nav button.active { background:var(--red); }

  .grid { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; padding:20px; }
  .card { background:var(--card); padding:10px; border-radius:8px; }
  .card img { width:100%; height:180px; object-fit:cover; border-radius:6px; }
  .card p { margin:8px 0; font-weight:bold; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; }
  .editBtn { background:#444; }
  .delBtn { background:#8b0000; }

  /* Player */
  #playerPage { display:none; position:fixed; inset:0; background:#000; color:#fff; z-index:1000; padding:20px; }
  #playerHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  #playerTitle { font-size:20px; margin:0; }
  #playerContainer { display:flex; justify-content:center; }
  #playerContainer video, #playerContainer iframe { width:92%; height:70vh; border-radius:10px; background:#000; }
  #playerError { display:none; background:#1a1a1a; border:1px solid var(--red); color:#fff; padding:12px; margin:12px auto; border-radius:6px; width:92%; }
  #closePlayer { width:auto; padding:10px 16px; }

  @media (max-width:1000px){ .grid { grid-template-columns:repeat(3,1fr); } }
  @media (max-width:700px){ .grid { grid-template-columns:repeat(2,1fr); } }
  @media (max-width:520px){
    .grid { grid-template-columns:1fr; }
    #playerContainer video, #playerContainer iframe { width:96%; height:58vh; }
    #logo { font-size:42px; }
  }
</style>
</head>
<body>

<h1 id="logo">CINEFLIX</h1>

<!-- LOGIN USUÁRIO -->
<div id="userPage" class="box">
  <h2>Entrar como Usuário</h2>
  <input id="userName" placeholder="Digite seu nome de usuário">
  <button class="btn-wide" onclick="enterUser()">Entrar</button>
  <p id="userMsg"></p>
  <hr>
  <p>Ou <span style="color:#e50914; cursor:pointer;" onclick="showAdminLogin()">Entrar como Admin</span></p>
</div>

<!-- CATÁLOGO -->
<div id="catalogPage" style="display:none;">
  <header>
    <h3>Olá, <span id="userEmail"></span></h3>
    <button onclick="logout()">Sair</button>
  </header>
  <nav>
    <button onclick="showPage('filmesPage',event)" class="active">Filmes</button>
    <button onclick="showPage('seriesPage',event)">Séries</button>
    <button onclick="showPage('novelasPage',event)">Novelas</button>
    <button onclick="showAdminLogin()" style="background:#444;">Login Admin</button>
  </nav>
</div>

<!-- FILMES -->
<div id="filmesPage" style="display:none;">
  <h2 style="text-align:center;">Catálogo de Filmes</h2>
  <div id="filmesCatalog" class="grid"></div>
</div>

<!-- SÉRIES -->
<div id="seriesPage" style="display:none;">
  <h2 style="text-align:center;">Catálogo de Séries</h2>
  <div id="seriesCatalog" class="grid"></div>
</div>

<!-- NOVELAS -->
<div id="novelasPage" style="display:none;">
  <h2 style="text-align:center;">Catálogo de Novelas</h2>
  <div id="novelasCatalog" class="grid"></div>
</div>

<!-- LOGIN ADMIN -->
<div id="adminLoginPage" class="box" style="display:none;">
  <h2>Login Admin</h2>
  <input id="adminEmail" placeholder="Usuário Admin">
  <input id="adminPass" type="password" placeholder="Senha Admin">
  <button id="adminLoginBtn" class="btn-wide">Entrar</button>
  <p id="adminLoginMsg"></p>
  <button class="alt btn-wide" onclick="backCatalog()">Voltar</button>
</div>

<!-- ADMIN -->
<div id="adminPage" class="box" style="display:none;">
  <h2 id="adminFormTitle">Adicionar Conteúdo</h2>
  <input id="adminTitulo" placeholder="Título">
  <input id="adminImagem" placeholder="URL da Imagem">
  <input id="adminVideo" placeholder="URL do Vídeo (YouTube ou MP4)">
  <select id="adminTipo">
    <option value="filmes">Filme</option>
    <option value="series">Série</option>
    <option value="novelas">Novela</option>
  </select>
  <button id="saveBtn" class="btn-wide">Salvar</button>
  <button class="alt btn-wide" onclick="backCatalog()">Voltar</button>
  <p id="adminMsg"></p>
</div>

<!-- PLAYER -->
<div id="playerPage">
  <div id="playerHeader">
    <h2 id="playerTitle">Reprodução</h2>
    <button id="closePlayer" onclick="closePlayer()">Fechar</button>
  </div>
  <div id="playerContainer"></div>
  <div id="playerError"></div>
</div>

<script>
/* Configuração de Admin */
const ADMIN_USER = "rian1";
const ADMIN_PASS = "rian2";

/* Estado de edição (índice do item) */
let editIndex = null;

/* Utils: normaliza URL e força https quando possível */
function normalizeUrl(raw){
  const url = (raw||"").trim();
  if(!url) return null;
  try{
    const u = new URL(url);
    if(u.protocol === "http:") u.protocol = "https:";
    return u.toString();
  }catch(e){
    try{ return new URL("https://" + url).toString(); }catch(e2){ return null; }
  }
}

/* Utils: converte YouTube para embed com parâmetros e suporte a watch/shorts/youtu.be */
function toYouTubeEmbed(url){
  try{
    const u = new URL(url);
    const host = u.hostname.replace("www.","");
    let id = null;

    if(host.includes("youtu.be")){
      id = u.pathname.slice(1);
    } else if(host.includes("youtube.com")){
      if(u.pathname.startsWith("/watch")){
        id = u.searchParams.get("v");
      } else if(u.pathname.startsWith("/shorts/")){
        id = u.pathname.split("/shorts/")[1];
      } else if(u.pathname.includes("/embed/")){
        id = u.pathname.split("/embed/")[1];
      }
    }

    if(!id) return null;

    const params = new URLSearchParams({
      autoplay: "1",
      mute: "1",
      rel: "0",
      modestbranding: "1",
      playsinline: "1",
      origin: location.origin
    });

    return `https://www.youtube.com/embed/${id}?${params.toString()}`;
  }catch(e){
    return null;
  }
}

/* LOGIN USUÁRIO */
function enterUser(){
  const name = userName.value.trim();
  if(!name){ userMsg.innerText = "Digite um nome válido."; return; }
  localStorage.setItem("currentUser", JSON.stringify({email:name, admin:false}));
  userPage.style.display = "none";
  catalogPage.style.display = "block";
  userEmail.innerText = name;
  loadCatalog();
  showPage('filmesPage', {target: document.querySelector('nav button')});
}

/* TROCAR PÁGINAS DO CATÁLOGO */
function showPage(pageId, evt){
  document.querySelectorAll('#filmesPage,#seriesPage,#novelasPage').forEach(p => p.style.display = "none");
  document.getElementById(pageId).style.display = "block";
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  if(evt && evt.target) evt.target.classList.add('active');
}

/* LOGIN ADMIN */
function showAdminLogin(){
  userPage.style.display = "none";
  catalogPage.style.display = "none";
  adminPage.style.display = "none";
  adminLoginPage.style.display = "block";
}

adminLoginBtn.onclick = () => {
  const email = adminEmail.value.trim();
  const pass = adminPass.value.trim();
  if(email === ADMIN_USER && pass === ADMIN_PASS){
    adminLoginPage.style.display = "none";
    adminPage.style.display = "block";
    adminLoginMsg.innerText = "";
    localStorage.setItem("currentUser", JSON.stringify({email:email, admin:true}));
    adminFormTitle.innerText = "Adicionar Conteúdo";
    editIndex = null;
  }else{
    adminLoginMsg.innerText = "Usuário ou senha inválidos.";
  }
};

/* VOLTAR PARA CATÁLOGO OU LOGIN */
function backCatalog(){
  adminLoginPage.style.display = "none";
  adminPage.style.display = "none";
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
  if(currentUser && currentUser.email){
    catalogPage.style.display = "block";
  }else{
    userPage.style.display = "block";
  }
}

/* SALVAR (ADICIONAR OU EDITAR) */
saveBtn.onclick = () => {
  const titulo = adminTitulo.value.trim();
  const imagem = adminImagem.value.trim();
  const videoRaw = adminVideo.value.trim();
  const tipo = adminTipo.value;
  if(!titulo || !imagem || !videoRaw){ adminMsg.innerText = "Preencha todos os campos."; return; }

  const video = normalizeUrl(videoRaw);
  if(!video){ adminMsg.innerText = "URL de vídeo inválida. Use YouTube ou link .mp4 via https."; return; }

  let conteudos = JSON.parse(localStorage.getItem("conteudos") || "[]");

  if(editIndex !== null){
    conteudos[editIndex] = {titulo, imagem, video, tipo};
    adminMsg.innerText = "Conteúdo atualizado!";
    adminFormTitle.innerText = "Adicionar Conteúdo";
    editIndex = null;
  }else{
    conteudos.push({titulo, imagem, video, tipo});
    adminMsg.innerText = "Conteúdo adicionado!";
  }

  localStorage.setItem("conteudos", JSON.stringify(conteudos));
  adminTitulo.value = ""; adminImagem.value = ""; adminVideo.value = "";
  loadCatalog();
  backCatalog();
};

/* CARREGAR CATÁLOGO */
function loadCatalog(){
  filmesCatalog.innerHTML = "";
  seriesCatalog.innerHTML = "";
  novelasCatalog.innerHTML = "";

  const conteudos = JSON.parse(localStorage.getItem("conteudos") || "[]");
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");

  conteudos.forEach((c, i) => {
    const card = `
      <div class="card">
        <img src="${c.imagem}" alt="${c.titulo}">
        <p>${c.titulo}</p>
        <div class="actions">
          <button onclick="openPlayer('${encodeURIComponent(c.titulo)}','${encodeURIComponent(c.video)}')">Assistir</button>
          ${currentUser.admin ? `
            <button class="editBtn" onclick="editItem(${i})">Editar</button>
            <button class="delBtn" onclick="deleteItem(${i})">Excluir</button>
          ` : ``}
        </div>
      </div>
    `;
    if(c.tipo === "filmes"){ filmesCatalog.innerHTML += card; }
    else if(c.tipo === "series"){ seriesCatalog.innerHTML += card; }
    else { novelasCatalog.innerHTML += card; }
  });
}

/* EDITAR ITEM (ADMIN) */
function editItem(index){
  const conteudos = JSON.parse(localStorage.getItem("conteudos") || "[]");
  const item = conteudos[index];
  if(!item) return;

  adminTitulo.value = item.titulo;
  adminImagem.value = item.imagem;
  adminVideo.value = item.video;
  adminTipo.value = item.tipo;

  adminFormTitle.innerText = "Editar Conteúdo";
  editIndex = index;
  adminMsg.innerText = "Editando item. Altere os campos e clique em Salvar.";

  catalogPage.style.display = "none";
  adminLoginPage.style.display = "none";
  adminPage.style.display = "block";
}

/* EXCLUIR ITEM (ADMIN) */
function deleteItem(index){
  if(!confirm("Tem certeza que deseja excluir este item?")) return;
  let conteudos = JSON.parse(localStorage.getItem("conteudos") || "[]");
  conteudos.splice(index, 1);
  localStorage.setItem("conteudos", JSON.stringify(conteudos));
  loadCatalog();
}

/* PLAYER: ABRIR COM SUPORTE A YOUTUBE E MP4 + FALLBACK */
function openPlayer(encodedTitle, encodedUrl){
  const title = decodeURIComponent(encodedTitle);
  const rawUrl = decodeURIComponent(encodedUrl);
  const url = (rawUrl || "").trim();

  const player = document.getElementById("playerPage");
  const container = document.getElementById("playerContainer");
  const error = document.getElementById("playerError");
  const titleEl = document.getElementById("playerTitle");

  titleEl.innerText = title;
  container.innerHTML = "";
  error.style.display = "none";

  const isYouTube = url.includes("youtube.com") || url.includes("youtu.be");

  // YouTube via iframe embed
  if(isYouTube){
    const embed = toYouTubeEmbed(url);
    if(embed){
      container.innerHTML = `
        <iframe src="${embed}" title="YouTube player" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
      `;
      // Watchdog: se não carregar rápido, mostra fallback para abrir no YouTube
      const watchdog = setTimeout(()=>{
        error.style.display = "block";
        error.innerHTML = `
          Este vídeo pode estar bloqueado para incorporação (erro 153).
          <br><br>
          <button onclick="window.open('${url}','_blank')">Assistir no YouTube</button>
        `;
      }, 3000);
      const iframe = container.querySelector("iframe");
      iframe.addEventListener("load", ()=> clearTimeout(watchdog));
    } else {
      error.style.display = "block";
      error.innerHTML = `
        Link do YouTube inválido ou sem ID detectável.
        <br><br>
        <button onclick="window.open('${url}','_blank')">Assistir no YouTube</button>
      `;
    }
    player.style.display = "block";
    return;
  }

  // MP4 direto
  if(url.toLowerCase().endsWith(".mp4")){
    container.innerHTML = `
      <video controls autoplay muted playsinline preload="metadata">
        <source src="${url}" type="video/mp4">
        Seu navegador não suporta o elemento de vídeo.
      </video>
    `;
    player.style.display = "block";
    return;
  }

  // Outros formatos
  error.style.display = "block";
  error.innerHTML = "Este link não é YouTube nem termina em .mp4. Use uma URL válida.";
  player.style.display = "block";
}

/* PLAYER: FECHAR */
function closePlayer(){
  const player = document.getElementById("playerPage");
  const container = document.getElementById("playerContainer");
  try{
    const vid = container.querySelector("video");
    if(vid) vid.pause();
  }catch(e){}
  container.innerHTML = "";
  document.getElementById("playerError").style.display = "none";
  player.style.display = "none";
}

/* LOGOUT */
function logout(){
  localStorage.removeItem("currentUser");
  location.reload();
}

/* INIT: restaura estado */
(function init(){
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
  if(currentUser && currentUser.email){
    userPage.style.display = "none";
    catalogPage.style.display = "block";
    userEmail.innerText = currentUser.email;
    loadCatalog();
    showPage('filmesPage', {target: document.querySelector('nav button')});
  }
})();
</script>

</body>
</html>

